<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ¨çº¿æ•°ç‹¬ - ç«‹å³å¼€å§‹æ¸¸æˆ</title>
  <meta name="description" content="åœ¨çº¿ç©æ•°ç‹¬æ¸¸æˆï¼Œæ”¯æŒç¬”è®°æ¨¡å¼ã€æš‚åœåŠŸèƒ½">
  <link rel="apple-touch-icon" href="/sudoku/app-icon.png">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* å¯¼èˆªæ  */
    .navbar {
      background: white;
      border-bottom: 1px solid #e5e5e7;
      padding: 12px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .navbar-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: #1d1d1f;
    }
    
    .logo img {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }
    
    .logo-text {
      font-size: 1.2em;
      font-weight: 600;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .nav-btn {
      padding: 8px 16px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .nav-btn:hover {
      background: #0051D5;
    }
    
    .nav-btn.secondary {
      background: #f5f5f7;
      color: #007AFF;
    }
    
    .nav-btn.secondary:hover {
      background: #e8e8ed;
    }
    
    /* æ¸¸æˆå®¹å™¨ */
    .game-container {
      flex: 1;
      display: flex;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      gap: 30px;
    }
    
    .game-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* æ¸¸æˆæ§åˆ¶æ  */
    .game-controls {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .control-btn {
      padding: 10px 20px;
      border: 1px solid #e5e5e7;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .control-btn:hover {
      background: #f5f5f7;
    }
    
    .control-btn.active {
      background: #007AFF;
      color: white;
      border-color: #007AFF;
    }
    
    .timer {
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      min-width: 80px;
      text-align: center;
    }
    
    /* æ•°ç‹¬æ£‹ç›˜ */
    .sudoku-board {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
      display: inline-block;
    }
    
    .board-grid {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 0;
      border: 3px solid #333;
      border-radius: 8px;
      overflow: hidden;
      width: var(--board-size);
      height: var(--board-size);
    }
    
    /* PCç«¯é»˜è®¤æ£‹ç›˜å¤§å° */
    :root {
      --board-size: 540px;
      --cell-font-size: 1.6em;
      --note-font-size: 0.45em;
    }
    
    .cell {
      aspect-ratio: 1;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--cell-font-size);
      font-weight: 500;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      background: white;
    }
    
    .cell:nth-child(3n):not(:nth-child(9n)) {
      border-right: 2px solid #333;
    }
    
    .cell:nth-child(n+19):nth-child(-n+27),
    .cell:nth-child(n+46):nth-child(-n+54) {
      border-bottom: 2px solid #333;
    }
    
    .cell:hover {
      background: #f5f5f7;
    }
    
    .cell.selected {
      background: #e3f2fd;
    }
    
    .cell.same-value {
      background: #fff3e0;
    }
    
    .cell.same-row,
    .cell.same-col,
    .cell.same-box {
      background: #f5f5f7;
    }
    
    .cell.fixed {
      color: #1d1d1f;
      font-weight: 700;
      cursor: default;
    }
    
    .cell.error {
      color: #ff3b30;
      background: #ffebee;
    }
    
    .cell.correct {
      color: #007AFF;
    }
    
    /* ç¬”è®°æ¨¡å¼ */
    .cell .notes {
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 0;
      font-size: var(--note-font-size);
      color: #666;
    }
    
    .cell .notes span {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* æ•°å­—é”®ç›˜ */
    .number-pad {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      max-width: 400px;
    }
    
    .num-btn {
      padding: 20px;
      border: 1px solid #e5e5e7;
      border-radius: 8px;
      background: white;
      font-size: 1.4em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .num-btn:hover {
      background: #007AFF;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    }
    
    .num-btn:active {
      transform: translateY(0);
    }
    
    .num-btn.erase {
      background: #ff3b30;
      color: white;
      border-color: #ff3b30;
    }
    
    .num-btn.erase:hover {
      background: #d70015;
    }
    
    .num-count {
      position: absolute;
      top: 2px;
      right: 4px;
      font-size: 0.7em;
      color: #999;
      font-weight: normal;
    }
    
    /* ä¾§è¾¹æ  */
    .game-sidebar {
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .sidebar-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .sidebar-card h3 {
      font-size: 1.2em;
      margin-bottom: 15px;
      color: #1d1d1f;
    }
    
    .difficulty-selector {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .diff-btn {
      padding: 12px;
      border: 1px solid #e5e5e7;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
    }
    
    .diff-btn:hover {
      background: #f5f5f7;
    }
    
    .diff-btn.active {
      background: #007AFF;
      color: white;
      border-color: #007AFF;
    }
    
    /* æš‚åœé®ç½© */
    .pause-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      flex-direction: column;
      gap: 20px;
    }
    
    .pause-overlay.active {
      display: flex;
    }
    
    .pause-icon {
      font-size: 4em;
      color: #007AFF;
    }
    
    .pause-text {
      font-size: 1.5em;
      font-weight: 600;
      color: #1d1d1f;
    }
    
    .resume-btn {
      padding: 12px 30px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .resume-btn:hover {
      background: #0051D5;
      transform: scale(1.05);
    }
    
    /* å®ŒæˆåŠ¨ç”» */
    .completion-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .completion-modal.active {
      display: flex;
    }
    
    .completion-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 400px;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .completion-icon {
      font-size: 5em;
      margin-bottom: 20px;
    }
    
    .completion-title {
      font-size: 2em;
      margin-bottom: 10px;
      color: #1d1d1f;
    }
    
    .completion-time {
      font-size: 1.3em;
      color: #666;
      margin-bottom: 30px;
    }
    
    /* å¹³æ¿å’Œå°å±å¹•PC */
    @media (max-width: 1024px) {
      :root {
        --board-size: 450px;
        --cell-font-size: 1.4em;
        --note-font-size: 0.4em;
      }
      
      .game-container {
        flex-direction: column;
      }
      
      .game-sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
      }
      
      .sidebar-card {
        min-width: 250px;
      }
    }
    
    /* æ‰‹æœºç«¯ */
    @media (max-width: 768px) {
      :root {
        --board-size: min(90vw, 400px);
        --cell-font-size: 1.2em;
        --note-font-size: 0.35em;
      }
      
      .number-pad {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .game-controls {
        padding: 15px;
        gap: 10px;
      }
      
      .control-group {
        width: 100%;
        justify-content: center;
      }
      
      .sudoku-board {
        padding: 15px;
      }
    }
    
    /* è¶…å°å±å¹• */
    @media (max-width: 480px) {
      :root {
        --board-size: calc(100vw - 40px);
        --cell-font-size: 1.1em;
        --note-font-size: 0.3em;
      }
      
      .game-container {
        padding: 10px;
      }
      
      .num-btn {
        padding: 15px;
        font-size: 1.2em;
      }
    }
    
    /* å¤§å±å¹• */
    @media (min-width: 1440px) {
      :root {
        --board-size: 600px;
        --cell-font-size: 1.8em;
        --note-font-size: 0.5em;
      }
    }
  </style>
</head>
<body>
  <!-- å¯¼èˆªæ  -->
  <nav class="navbar">
    <div class="navbar-content">
      <a href="/sudoku/" class="logo">
        <img src="/sudoku/app-icon.png" alt="æ•°ç‹¬">
        <span class="logo-text" data-i18n="appName">æ•°ç‹¬</span>
      </a>
      <div class="nav-buttons">
        <a href="/sudoku/" class="nav-btn secondary" data-i18n="backHome">è¿”å›é¦–é¡µ</a>
        <a href="https://apps.apple.com/app/id6748750942" class="nav-btn" data-i18n="downloadApp">ä¸‹è½½åº”ç”¨</a>
      </div>
    </div>
  </nav>
  
  <!-- æ¸¸æˆå®¹å™¨ -->
  <div class="game-container">
    <!-- ä¸»æ¸¸æˆåŒº -->
    <div class="game-main">
      <!-- æ¸¸æˆæ§åˆ¶ -->
      <div class="game-controls">
        <div class="control-group">
          <button class="control-btn" onclick="togglePause()" id="pauseBtn">
            <span data-i18n="pause">â¸ æš‚åœ</span>
          </button>
          <div class="timer" id="timer">00:00</div>
        </div>
        
        <div class="control-group">
          <button class="control-btn" onclick="toggleNoteMode()" id="noteBtn">
            <span data-i18n="notes">âœï¸ ç¬”è®°</span>
          </button>
          <button class="control-btn" onclick="undoMove()">
            <span data-i18n="undo">â†©ï¸ æ’¤é”€</span>
          </button>
          <button class="control-btn" onclick="getHint()">
            <span data-i18n="hint">ğŸ’¡ æç¤º</span>
          </button>
        </div>
      </div>
      
      <!-- æ•°ç‹¬æ£‹ç›˜ -->
      <div class="sudoku-board">
        <div class="board-grid" id="board"></div>
        
        <!-- æš‚åœé®ç½© -->
        <div class="pause-overlay" id="pauseOverlay">
          <div class="pause-icon">â¸</div>
          <div class="pause-text" data-i18n="gamePaused">æ¸¸æˆå·²æš‚åœ</div>
          <button class="resume-btn" onclick="togglePause()" data-i18n="resume">ç»§ç»­æ¸¸æˆ</button>
        </div>
      </div>
      
      <!-- æ•°å­—é”®ç›˜ -->
      <div class="number-pad" id="numberPad">
        <button class="num-btn" onclick="inputNumber(1)">1<span class="num-count" id="count1"></span></button>
        <button class="num-btn" onclick="inputNumber(2)">2<span class="num-count" id="count2"></span></button>
        <button class="num-btn" onclick="inputNumber(3)">3<span class="num-count" id="count3"></span></button>
        <button class="num-btn" onclick="inputNumber(4)">4<span class="num-count" id="count4"></span></button>
        <button class="num-btn" onclick="inputNumber(5)">5<span class="num-count" id="count5"></span></button>
        <button class="num-btn" onclick="inputNumber(6)">6<span class="num-count" id="count6"></span></button>
        <button class="num-btn" onclick="inputNumber(7)">7<span class="num-count" id="count7"></span></button>
        <button class="num-btn" onclick="inputNumber(8)">8<span class="num-count" id="count8"></span></button>
        <button class="num-btn" onclick="inputNumber(9)">9<span class="num-count" id="count9"></span></button>
        <button class="num-btn erase" onclick="eraseCell()" data-i18n="erase">æ“¦é™¤</button>
      </div>
    </div>
    
    <!-- ä¾§è¾¹æ  -->
    <div class="game-sidebar">
      <!-- éš¾åº¦é€‰æ‹© -->
      <div class="sidebar-card">
        <h3 data-i18n="difficulty">éš¾åº¦é€‰æ‹©</h3>
        <div class="difficulty-selector">
          <button class="diff-btn active" onclick="newGame('easy')" data-i18n="easy">ç®€å•</button>
          <button class="diff-btn" onclick="newGame('medium')" data-i18n="medium">ä¸­ç­‰</button>
          <button class="diff-btn" onclick="newGame('hard')" data-i18n="hard">å›°éš¾</button>
        </div>
      </div>
      
      <!-- æ¸¸æˆä¿¡æ¯ -->
      <div class="sidebar-card">
        <h3 data-i18n="gameInfo">æ¸¸æˆä¿¡æ¯</h3>
        <p data-i18n="hintsRemaining">å‰©ä½™æç¤º: <span id="hints">3</span></p>
        <p data-i18n="mistakes">é”™è¯¯æ¬¡æ•°: <span id="mistakes">0</span></p>
      </div>
      
      <!-- è¯­è¨€åˆ‡æ¢ -->
      <div class="sidebar-card">
        <h3 data-i18n="language">è¯­è¨€</h3>
        <div class="difficulty-selector">
          <button class="diff-btn active" onclick="switchLanguage('en')">English</button>
          <button class="diff-btn" onclick="switchLanguage('ja')">æ—¥æœ¬èª</button>
          <button class="diff-btn" onclick="switchLanguage('zh')">ä¸­æ–‡</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å®Œæˆå¼¹çª— -->
  <div class="completion-modal" id="completionModal">
    <div class="completion-content">
      <div class="completion-icon">ğŸ‰</div>
      <h2 class="completion-title" data-i18n="congratulations">æ­å–œå®Œæˆï¼</h2>
      <p class="completion-time" data-i18n="completionTime">ç”¨æ—¶: <span id="finalTime">00:00</span></p>
      <button class="nav-btn" onclick="closeCompletion()" data-i18n="newGame">å¼€å§‹æ–°æ¸¸æˆ</button>
    </div>
  </div>
  
  <script>
    // æ¸¸æˆçŠ¶æ€
    let gameState = {
      board: [],
      solution: [],
      selectedCell: null,
      noteMode: false,
      paused: false,
      time: 0,
      hints: 3,
      mistakes: 0,
      history: [],
      difficulty: 'easy'
    };
    
    // å®šæ—¶å™¨
    let timerInterval = null;
    
    // å¤šè¯­è¨€æ”¯æŒ
    const translations = {
      zh: {
        appName: 'æ•°ç‹¬',
        backHome: 'è¿”å›é¦–é¡µ',
        downloadApp: 'ä¸‹è½½åº”ç”¨',
        pause: 'â¸ æš‚åœ',
        resume: 'ç»§ç»­æ¸¸æˆ',
        notes: 'âœï¸ ç¬”è®°',
        undo: 'â†©ï¸ æ’¤é”€',
        hint: 'ğŸ’¡ æç¤º',
        erase: 'æ“¦é™¤',
        difficulty: 'éš¾åº¦é€‰æ‹©',
        easy: 'ç®€å•',
        medium: 'ä¸­ç­‰',
        hard: 'å›°éš¾',
        gameInfo: 'æ¸¸æˆä¿¡æ¯',
        hintsRemaining: 'å‰©ä½™æç¤º: ',
        mistakes: 'é”™è¯¯æ¬¡æ•°: ',
        language: 'è¯­è¨€',
        gamePaused: 'æ¸¸æˆå·²æš‚åœ',
        congratulations: 'æ­å–œå®Œæˆï¼',
        completionTime: 'ç”¨æ—¶: ',
        newGame: 'å¼€å§‹æ–°æ¸¸æˆ'
      },
      en: {
        appName: 'Sudoku',
        backHome: 'Back Home',
        downloadApp: 'Download App',
        pause: 'â¸ Pause',
        resume: 'Resume',
        notes: 'âœï¸ Notes',
        undo: 'â†©ï¸ Undo',
        hint: 'ğŸ’¡ Hint',
        erase: 'Erase',
        difficulty: 'Difficulty',
        easy: 'Easy',
        medium: 'Medium',
        hard: 'Hard',
        gameInfo: 'Game Info',
        hintsRemaining: 'Hints: ',
        mistakes: 'Mistakes: ',
        language: 'Language',
        gamePaused: 'Game Paused',
        congratulations: 'Congratulations!',
        completionTime: 'Time: ',
        newGame: 'New Game'
      },
      ja: {
        appName: 'æ•°ç‹¬',
        backHome: 'ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹',
        downloadApp: 'ã‚¢ãƒ—ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
        pause: 'â¸ ä¸€æ™‚åœæ­¢',
        resume: 'å†é–‹',
        notes: 'âœï¸ ãƒ¡ãƒ¢',
        undo: 'â†©ï¸ å…ƒã«æˆ»ã™',
        hint: 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ',
        erase: 'æ¶ˆå»',
        difficulty: 'é›£æ˜“åº¦',
        easy: 'ç°¡å˜',
        medium: 'æ™®é€š',
        hard: 'é›£ã—ã„',
        gameInfo: 'ã‚²ãƒ¼ãƒ æƒ…å ±',
        hintsRemaining: 'ãƒ’ãƒ³ãƒˆ: ',
        mistakes: 'ãƒŸã‚¹: ',
        language: 'è¨€èª',
        gamePaused: 'ä¸€æ™‚åœæ­¢ä¸­',
        congratulations: 'ãŠã‚ã§ã¨ã†ï¼',
        completionTime: 'æ™‚é–“: ',
        newGame: 'æ–°ã—ã„ã‚²ãƒ¼ãƒ '
      }
    };
    
    let currentLang = 'en';
    
    // åˆå§‹åŒ–æ¸¸æˆ
    function initGame() {
      createBoard();
      newGame('easy');
      startTimer();
      updateNumberCounts();
      
      // åŠ¨æ€è°ƒæ•´æ£‹ç›˜å¤§å°
      adjustBoardSize();
      window.addEventListener('resize', adjustBoardSize);
    }
    
    // åŠ¨æ€è°ƒæ•´æ£‹ç›˜å¤§å°
    function adjustBoardSize() {
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const screenWidth = window.innerWidth;
      const root = document.documentElement;
      
      if (isMobile || screenWidth < 768) {
        // ç§»åŠ¨è®¾å¤‡
        const boardSize = Math.min(screenWidth - 40, 400);
        root.style.setProperty('--board-size', `${boardSize}px`);
        root.style.setProperty('--cell-font-size', screenWidth < 360 ? '1em' : '1.2em');
        root.style.setProperty('--note-font-size', screenWidth < 360 ? '0.28em' : '0.35em');
      } else if (screenWidth < 1024) {
        // å¹³æ¿
        root.style.setProperty('--board-size', '450px');
        root.style.setProperty('--cell-font-size', '1.4em');
        root.style.setProperty('--note-font-size', '0.4em');
      } else if (screenWidth >= 1440) {
        // å¤§å±å¹•
        root.style.setProperty('--board-size', '600px');
        root.style.setProperty('--cell-font-size', '1.8em');
        root.style.setProperty('--note-font-size', '0.5em');
      } else {
        // æ ‡å‡†PC
        root.style.setProperty('--board-size', '540px');
        root.style.setProperty('--cell-font-size', '1.6em');
        root.style.setProperty('--note-font-size', '0.45em');
      }
    }
    
    // åˆ›å»ºæ£‹ç›˜
    function createBoard() {
      const board = document.getElementById('board');
      board.innerHTML = '';
      
      for (let i = 0; i < 81; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = i;
        cell.onclick = () => selectCell(i);
        board.appendChild(cell);
      }
    }
    
    // ç”Ÿæˆæ•°ç‹¬é¢˜ç›®
    function generateSudoku(difficulty) {
      // è¿™é‡Œä½¿ç”¨ç®€åŒ–çš„æ•°ç‹¬ç”Ÿæˆç®—æ³•
      // å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨æ›´å¤æ‚çš„ç®—æ³•
      const solution = generateCompleteSudoku();
      const puzzle = createPuzzle(solution, difficulty);
      
      return { puzzle, solution };
    }
    
    // ç”Ÿæˆå®Œæ•´çš„æ•°ç‹¬è§£
    function generateCompleteSudoku() {
      const board = Array(9).fill().map(() => Array(9).fill(0));
      
      // å¡«å……ç¬¬ä¸€è¡Œ
      const nums = [1,2,3,4,5,6,7,8,9];
      for (let i = 0; i < 9; i++) {
        const idx = Math.floor(Math.random() * nums.length);
        board[0][i] = nums[idx];
        nums.splice(idx, 1);
      }
      
      // ä½¿ç”¨å›æº¯ç®—æ³•å¡«å……å‰©ä½™æ ¼å­
      solveSudoku(board);
      return board;
    }
    
    // å›æº¯ç®—æ³•è§£æ•°ç‹¬
    function solveSudoku(board) {
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (board[row][col] === 0) {
            for (let num = 1; num <= 9; num++) {
              if (isValidMove(board, row, col, num)) {
                board[row][col] = num;
                if (solveSudoku(board)) {
                  return true;
                }
                board[row][col] = 0;
              }
            }
            return false;
          }
        }
      }
      return true;
    }
    
    // æ£€æŸ¥ç§»åŠ¨æ˜¯å¦æœ‰æ•ˆ
    function isValidMove(board, row, col, num) {
      // æ£€æŸ¥è¡Œ
      for (let i = 0; i < 9; i++) {
        if (board[row][i] === num) return false;
      }
      
      // æ£€æŸ¥åˆ—
      for (let i = 0; i < 9; i++) {
        if (board[i][col] === num) return false;
      }
      
      // æ£€æŸ¥3x3å®«æ ¼
      const boxRow = Math.floor(row / 3) * 3;
      const boxCol = Math.floor(col / 3) * 3;
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          if (board[boxRow + i][boxCol + j] === num) return false;
        }
      }
      
      return true;
    }
    
    // åˆ›å»ºè°œé¢˜ï¼ˆç§»é™¤ä¸€äº›æ•°å­—ï¼‰
    function createPuzzle(solution, difficulty) {
      const puzzle = solution.map(row => [...row]);
      const cellsToRemove = difficulty === 'easy' ? 40 : difficulty === 'medium' ? 50 : 60;
      
      let removed = 0;
      while (removed < cellsToRemove) {
        const row = Math.floor(Math.random() * 9);
        const col = Math.floor(Math.random() * 9);
        if (puzzle[row][col] !== 0) {
          puzzle[row][col] = 0;
          removed++;
        }
      }
      
      return puzzle;
    }
    
    // å¼€å§‹æ–°æ¸¸æˆ
    function newGame(difficulty) {
      // æ›´æ–°éš¾åº¦æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.diff-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // ç”Ÿæˆæ–°è°œé¢˜
      const { puzzle, solution } = generateSudoku(difficulty);
      
      // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
      gameState = {
        board: puzzle.map(row => row.map(cell => ({
          value: cell,
          fixed: cell !== 0,
          notes: []
        }))),
        solution: solution,
        selectedCell: null,
        noteMode: false,
        paused: false,
        time: 0,
        hints: 3,
        mistakes: 0,
        history: [],
        difficulty: difficulty
      };
      
      // é‡ç½®ç•Œé¢
      document.getElementById('hints').textContent = gameState.hints;
      document.getElementById('mistakes').textContent = gameState.mistakes;
      document.getElementById('pauseOverlay').classList.remove('active');
      document.getElementById('completionModal').classList.remove('active');
      
      // æ›´æ–°æ£‹ç›˜æ˜¾ç¤º
      updateBoard();
      updateNumberCounts();
    }
    
    // æ›´æ–°æ£‹ç›˜æ˜¾ç¤º
    function updateBoard() {
      const cells = document.querySelectorAll('.cell');
      
      cells.forEach((cell, index) => {
        const row = Math.floor(index / 9);
        const col = index % 9;
        const cellData = gameState.board[row][col];
        
        // æ¸…é™¤æ‰€æœ‰ç±»
        cell.className = 'cell';
        
        // æ·»åŠ å›ºå®šæ•°å­—ç±»
        if (cellData.fixed) {
          cell.classList.add('fixed');
        }
        
        // æ·»åŠ é€‰ä¸­ç±»
        if (gameState.selectedCell === index) {
          cell.classList.add('selected');
        }
        
        // æ·»åŠ ç›¸å…³æ ¼å­é«˜äº®
        if (gameState.selectedCell !== null) {
          const selectedRow = Math.floor(gameState.selectedCell / 9);
          const selectedCol = gameState.selectedCell % 9;
          const selectedValue = gameState.board[selectedRow][selectedCol].value;
          
          if (row === selectedRow) cell.classList.add('same-row');
          if (col === selectedCol) cell.classList.add('same-col');
          
          const boxRow = Math.floor(row / 3);
          const boxCol = Math.floor(col / 3);
          const selectedBoxRow = Math.floor(selectedRow / 3);
          const selectedBoxCol = Math.floor(selectedCol / 3);
          if (boxRow === selectedBoxRow && boxCol === selectedBoxCol) {
            cell.classList.add('same-box');
          }
          
          if (cellData.value && cellData.value === selectedValue) {
            cell.classList.add('same-value');
          }
        }
        
        // æ£€æŸ¥é”™è¯¯
        if (cellData.value && !cellData.fixed) {
          if (cellData.value !== gameState.solution[row][col]) {
            cell.classList.add('error');
          } else {
            cell.classList.add('correct');
          }
        }
        
        // æ˜¾ç¤ºå†…å®¹
        if (cellData.value) {
          cell.textContent = cellData.value;
          cell.innerHTML = cellData.value;
        } else if (cellData.notes.length > 0) {
          const notesHtml = '<div class="notes">' +
            [1,2,3,4,5,6,7,8,9].map(n => 
              `<span>${cellData.notes.includes(n) ? n : ''}</span>`
            ).join('') +
            '</div>';
          cell.innerHTML = notesHtml;
        } else {
          cell.innerHTML = '';
        }
      });
    }
    
    // é€‰æ‹©æ ¼å­
    function selectCell(index) {
      if (gameState.paused) return;
      
      gameState.selectedCell = index;
      updateBoard();
    }
    
    // è¾“å…¥æ•°å­—
    function inputNumber(num) {
      if (gameState.paused || gameState.selectedCell === null) return;
      
      const row = Math.floor(gameState.selectedCell / 9);
      const col = gameState.selectedCell % 9;
      const cell = gameState.board[row][col];
      
      if (cell.fixed) return;
      
      // ä¿å­˜å†å²è®°å½•
      gameState.history.push({
        index: gameState.selectedCell,
        oldValue: cell.value,
        oldNotes: [...cell.notes],
        noteMode: gameState.noteMode
      });
      
      if (gameState.noteMode) {
        // ç¬”è®°æ¨¡å¼
        if (cell.notes.includes(num)) {
          cell.notes = cell.notes.filter(n => n !== num);
        } else {
          cell.notes.push(num);
          cell.notes.sort();
        }
        cell.value = 0;
      } else {
        // æ™®é€šæ¨¡å¼
        cell.value = num;
        cell.notes = [];
        
        // æ£€æŸ¥æ˜¯å¦æ­£ç¡®
        if (num !== gameState.solution[row][col]) {
          gameState.mistakes++;
          document.getElementById('mistakes').textContent = gameState.mistakes;
        }
        
        // æ¸…é™¤ç›¸å…³æ ¼å­çš„ç¬”è®°
        clearRelatedNotes(row, col, num);
      }
      
      updateBoard();
      updateNumberCounts();
      checkCompletion();
    }
    
    // æ¸…é™¤ç›¸å…³æ ¼å­çš„ç¬”è®°
    function clearRelatedNotes(row, col, num) {
      // æ¸…é™¤åŒè¡Œ
      for (let i = 0; i < 9; i++) {
        gameState.board[row][i].notes = gameState.board[row][i].notes.filter(n => n !== num);
      }
      
      // æ¸…é™¤åŒåˆ—
      for (let i = 0; i < 9; i++) {
        gameState.board[i][col].notes = gameState.board[i][col].notes.filter(n => n !== num);
      }
      
      // æ¸…é™¤åŒå®«æ ¼
      const boxRow = Math.floor(row / 3) * 3;
      const boxCol = Math.floor(col / 3) * 3;
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          gameState.board[boxRow + i][boxCol + j].notes = 
            gameState.board[boxRow + i][boxCol + j].notes.filter(n => n !== num);
        }
      }
    }
    
    // æ“¦é™¤æ ¼å­
    function eraseCell() {
      if (gameState.paused || gameState.selectedCell === null) return;
      
      const row = Math.floor(gameState.selectedCell / 9);
      const col = gameState.selectedCell % 9;
      const cell = gameState.board[row][col];
      
      if (cell.fixed) return;
      
      gameState.history.push({
        index: gameState.selectedCell,
        oldValue: cell.value,
        oldNotes: [...cell.notes],
        noteMode: false
      });
      
      cell.value = 0;
      cell.notes = [];
      
      updateBoard();
      updateNumberCounts();
    }
    
    // æ’¤é”€
    function undoMove() {
      if (gameState.history.length === 0) return;
      
      const lastMove = gameState.history.pop();
      const row = Math.floor(lastMove.index / 9);
      const col = lastMove.index % 9;
      const cell = gameState.board[row][col];
      
      cell.value = lastMove.oldValue;
      cell.notes = lastMove.oldNotes;
      
      updateBoard();
      updateNumberCounts();
    }
    
    // æç¤º
    function getHint() {
      if (gameState.hints <= 0 || gameState.paused) return;
      
      // æ‰¾åˆ°ä¸€ä¸ªç©ºæ ¼å­
      const emptyCells = [];
      for (let i = 0; i < 81; i++) {
        const row = Math.floor(i / 9);
        const col = i % 9;
        if (gameState.board[row][col].value === 0) {
          emptyCells.push({ row, col, index: i });
        }
      }
      
      if (emptyCells.length === 0) return;
      
      // éšæœºé€‰æ‹©ä¸€ä¸ªç©ºæ ¼å­
      const { row, col, index } = emptyCells[Math.floor(Math.random() * emptyCells.length)];
      
      // å¡«å…¥æ­£ç¡®ç­”æ¡ˆ
      gameState.selectedCell = index;
      gameState.board[row][col].value = gameState.solution[row][col];
      gameState.board[row][col].notes = [];
      
      gameState.hints--;
      document.getElementById('hints').textContent = gameState.hints;
      
      updateBoard();
      updateNumberCounts();
      checkCompletion();
    }
    
    // åˆ‡æ¢ç¬”è®°æ¨¡å¼
    function toggleNoteMode() {
      gameState.noteMode = !gameState.noteMode;
      document.getElementById('noteBtn').classList.toggle('active');
    }
    
    // åˆ‡æ¢æš‚åœ
    function togglePause() {
      gameState.paused = !gameState.paused;
      document.getElementById('pauseOverlay').classList.toggle('active');
      
      if (gameState.paused) {
        document.getElementById('pauseBtn').innerHTML = '<span data-i18n="resume">â–¶ï¸ ç»§ç»­</span>';
      } else {
        document.getElementById('pauseBtn').innerHTML = '<span data-i18n="pause">â¸ æš‚åœ</span>';
      }
      
      updateLanguage();
    }
    
    // æ›´æ–°æ•°å­—è®¡æ•°
    function updateNumberCounts() {
      const counts = Array(10).fill(0);
      
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          const value = gameState.board[row][col].value;
          if (value) counts[value]++;
        }
      }
      
      for (let i = 1; i <= 9; i++) {
        const remaining = 9 - counts[i];
        const element = document.getElementById(`count${i}`);
        if (element) {
          element.textContent = remaining > 0 ? remaining : '';
        }
      }
    }
    
    // æ£€æŸ¥å®Œæˆ
    function checkCompletion() {
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          const cell = gameState.board[row][col];
          if (!cell.value || cell.value !== gameState.solution[row][col]) {
            return false;
          }
        }
      }
      
      // æ¸¸æˆå®Œæˆ
      document.getElementById('completionModal').classList.add('active');
      document.getElementById('finalTime').textContent = formatTime(gameState.time);
      clearInterval(timerInterval);
    }
    
    // å…³é—­å®Œæˆå¼¹çª—
    function closeCompletion() {
      document.getElementById('completionModal').classList.remove('active');
      newGame(gameState.difficulty);
    }
    
    // å¯åŠ¨è®¡æ—¶å™¨
    function startTimer() {
      timerInterval = setInterval(() => {
        if (!gameState.paused) {
          gameState.time++;
          document.getElementById('timer').textContent = formatTime(gameState.time);
        }
      }, 1000);
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // åˆ‡æ¢è¯­è¨€
    function switchLanguage(lang) {
      currentLang = lang;
      
      document.querySelectorAll('.sidebar-card .diff-btn').forEach(btn => {
        if (btn.onclick.toString().includes('switchLanguage')) {
          btn.classList.remove('active');
        }
      });
      event.target.classList.add('active');
      
      updateLanguage();
    }
    
    // æ›´æ–°è¯­è¨€æ˜¾ç¤º
    function updateLanguage() {
      const t = translations[currentLang];
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (t[key]) {
          if (element.tagName === 'BUTTON' || element.tagName === 'SPAN') {
            element.textContent = t[key];
          } else {
            element.innerHTML = t[key];
          }
        }
      });
      
      // æ›´æ–°ç‰¹æ®Šå…ƒç´ 
      document.getElementById('hints').parentNode.innerHTML = t.hintsRemaining + '<span id="hints">' + gameState.hints + '</span>';
      document.getElementById('mistakes').parentNode.innerHTML = t.mistakes + '<span id="mistakes">' + gameState.mistakes + '</span>';
    }
    
    // é”®ç›˜æ”¯æŒ
    document.addEventListener('keydown', (e) => {
      if (gameState.paused || gameState.selectedCell === null) return;
      
      if (e.key >= '1' && e.key <= '9') {
        inputNumber(parseInt(e.key));
      } else if (e.key === 'Delete' || e.key === 'Backspace') {
        eraseCell();
      } else if (e.key === 'n' || e.key === 'N') {
        toggleNoteMode();
      } else if (e.key === ' ') {
        togglePause();
        e.preventDefault();
      }
    });
    
    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      initGame();
      updateLanguage();
    });
  </script>
</body>
</html>